// Prisma schema for the Iris Kooij Engine
// SQLite for dev; can switch to Postgres later

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  EDITOR
  VIEWER
}

enum VentureStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model Brand {
  id             String   @id @default(cuid())
  slug           String   @unique
  name           String
  domain         String?  @unique
  primaryColor   String?  // hex
  secondaryColor String?  // hex
  ventures       Venture[]
  mediaAssets    MediaAsset[]
  pages          Page[]
  blogPosts      BlogPost[]
  // New navigation + branding fields
  showInNav      Boolean  @default(true)
  navOrder       Int      @default(0)
  logoUrl        String?
  navigationLinks NavigationLink[]
  navigationLinkDrafts NavigationLinkDraft[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Navigation links per brand (DB-driven main navigation)
model NavigationLink {
  id       String  @id @default(cuid())
  label    String
  href     String
  order    Int     @default(0)
  brand    Brand   @relation(fields: [brandId], references: [id])
  brandId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Venture {
  id               String        @id @default(cuid())
  slug             String        @unique
  name             String
  tagline          String?
  shortDescription String
  longDescription  String
  website          String?
  status           VentureStatus @default(ACTIVE)
  featuredImageUrl String?
  featuredImageAlt String?
  valueProps       Json          // array of strings
  ctaLabel         String?
  // Booking & service metadata
  durationMinutes  Int?
  priceCents       Int?
  currency         String?       @default("EUR")
  bookingLink      String?
  contraindications String?
  faq              Json?
  brand            Brand         @relation(fields: [brandId], references: [id])
  brandId          String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      Role     @default(VIEWER)
  passwordHash String?
  createdAt DateTime @default(now())
  auditLogs AuditLog[]
  mediaUploads MediaAsset[] @relation("UserMediaUploads")
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  data      Json?
  createdAt DateTime @default(now())
}

model MediaAsset {
  id               String   @id @default(cuid())
  filename         String
  url              String
  mimeType         String?
  altText          String?
  brand            Brand?  @relation(fields: [brandId], references: [id])
  brandId          String?
  uploadedBy       User?   @relation(name: "UserMediaUploads", fields: [uploadedByUserId], references: [id])
  uploadedByUserId String?
  pHash            String? // perceptual hash for duplicate detection
  variants         MediaAssetVariant[]
  imageProcessingJobs ImageProcessingJob[]
  createdAt        DateTime @default(now())
}

model MediaAssetVariant {
  id          String   @id @default(cuid())
  mediaAsset  MediaAsset @relation(fields: [mediaAssetId], references: [id])
  mediaAssetId String
  width       Int
  height      Int
  format      String // e.g. webp, jpeg
  url         String
  createdAt   DateTime @default(now())
}

model ImageProcessingJob {
  id          String   @id @default(cuid())
  mediaAsset  MediaAsset @relation(fields: [mediaAssetId], references: [id])
  mediaAssetId String
  widths      Json // e.g. [320,640,1280]
  status      String  @default("PENDING") // PENDING | PROCESSING | DONE | ERROR
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model NavigationLinkDraft {
  id       String  @id @default(cuid())
  label    String
  href     String
  order    Int     @default(0)
  brand    Brand   @relation(fields: [brandId], references: [id])
  brandId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogPost {
  id             String   @id @default(cuid())
  slug           String   @unique
  title          String
  excerpt        String?
  coverImageUrl  String?
  coverImageAlt  String?
  content        Json
  published      Boolean  @default(false)
  publishedAt    DateTime?
  authorName     String?
  readingMinutes Int?
  seoTitle       String?
  seoDescription String?
  brand          Brand    @relation(fields: [brandId], references: [id])
  brandId        String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([brandId, slug])
  @@index([brandId, published, publishedAt])
}

// Simple CMS pages and sections for editable marketing content
model Page {
  id          String   @id @default(cuid())
  slug        String
  title       String
  description String?
  published   Boolean  @default(true)
  brand       Brand    @relation(fields: [brandId], references: [id])
  brandId     String
  sections    PageSection[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([brandId, slug])
}

enum PageSectionType {
  HERO
  TEXT
  FEATURES
  CTA
  NEWSLETTER
  IMAGE
  FAQ
  VENTURES
  RITUALS
  CONTACT_INFO
  TESTIMONIALS
  TIMELINE
}

model PageSection {
  id        String          @id @default(cuid())
  page      Page            @relation(fields: [pageId], references: [id])
  pageId    String
  order     Int             @default(0)
  type      PageSectionType
  data      Json            // flexible payload per type
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([pageId, order])
}

// Deployment logs persisted from Vercel API for audit/history
model DeploymentLog {
  id          String   @id @default(cuid())
  uid         String   @unique
  url         String
  name        String?
  readyState  String?
  target      String?
  deployedAt  DateTime
  source      String   @default("vercel")
  insertedAt  DateTime @default(now())

  @@index([deployedAt])
}
